name: Naver OAuth Bootstrap

on:
  workflow_dispatch: {}  # 수동 실행 버튼

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      statuses: write
      id-token: write
    env:
      NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
      NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
      WEBHOOK_ID: ${{ secrets.WEBHOOK_ID }}
      WEBHOOK_TOKEN: ${{ secrets.WEBHOOK_TOKEN }}
      REDIRECT_URI: https://webhook.site/${{ secrets.WEBHOOK_ID }}

    steps:
      - name: Show authorize URL
        id: authurl
        run: |
          STATE=$(head -c 18 /dev/urandom | base64 | tr -dc 'A-Za-z0-9' | head -c 24)
          AUTH_URL="https://nid.naver.com/oauth2.0/authorize?response_type=code&client_id=${NAVER_CLIENT_ID}&redirect_uri=$(python3 - <<'PY'
import urllib.parse,os
print(urllib.parse.quote(os.environ['REDIRECT_URI'], safe=''))
PY
)&state=${STATE}"
          echo "Authorize URL: $AUTH_URL"
          echo "STATE=$STATE" >> $GITHUB_ENV
          echo "auth-url=$AUTH_URL" >> $GITHUB_OUTPUT
          echo ""
          echo "[1/3] 위 URL을 클릭해 네이버 로그인/동의하세요."
          echo "동의 후 열리는 webhook.site 페이지는 닫아도 됩니다."

      - name: Wait for OAuth callback on webhook.site (up to 5 minutes)
        id: waitcode
        run: |
          python3 - <<'PY'
import os, time, sys, json, urllib.parse
import urllib.request
TOKEN=os.environ['WEBHOOK_TOKEN']
STATE=os.environ['STATE']
API=f"https://webhook.site/token/{TOKEN}/requests?page=1"

def fetch():
    with urllib.request.urlopen(API, timeout=20) as r:
        return json.load(r)

code=None
start=time.time()
while time.time()-start < 300:  # 5 minutes
    data=fetch()
    for req in data.get('data', []):
        url=req.get('url','') or ''
        q=urllib.parse.urlparse(url).query
        qs=urllib.parse.parse_qs(q)
        c=qs.get('code',[None])[0]
        s=qs.get('state',[None])[0]
        if c and s==STATE:
            code=c
            break
    if code:
        break
    time.sleep(3)

if not code:
    print('ERROR: code not received. Make sure you clicked the authorize URL and the redirect URI matches in Naver console.')
    sys.exit(1)

print('Got code:', code)
with open(os.environ['GITHUB_OUTPUT'],'a') as f:
    f.write(f"code={code}\n")
PY
